<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>MindFlow ‚Äî Advanced Meditation Analytics</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <link rel="stylesheet" href="styles.css" />

    <style>
        
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">üßò</div>
                <div>
                    <h1>MindFlow</h1>
                    <div class="subtitle">Advanced Meditation Analytics Platform</div>
                </div>
            </div>
            <div style="display:flex;gap:0.5rem;">
                <button id="exportCsv" class="btn btn-secondary"><span>üìä</span> Export</button>
                <button id="clearHistory" class="btn btn-secondary"><span>üóëÔ∏è</span> Clear</button>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-card">
            <!-- Row 1: Profile -->
            <div class="controls"
                style="margin-bottom: 1rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                <div class="control-group">
                    <label>Full Name</label>
                    <input type="text" id="userName" placeholder="Your Name"
                        style="padding: 0.6rem; background: var(--bg-tertiary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.8rem; width: 180px;">
                </div>
                <div class="control-group">
                    <label>Age</label>
                    <input type="number" id="userAge" placeholder="Age" min="1" max="120"
                        style="padding: 0.6rem; background: var(--bg-tertiary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.8rem; width: 80px;">
                </div>
                <div class="control-group">
                    <label>Gender</label>
                    <select id="userGender"
                        style="padding: 0.6rem; background: var(--bg-tertiary); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 0.8rem; width: 100px;">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Skin Tone</label>
                    <select id="userSkinTone" style="min-width: 120px;">
                        <option value="Type 1">Type 1 (Very Light)</option>
                        <option value="Type 2">Type 2 (Light)</option>
                        <option value="Type 3">Type 3 (Medium)</option>
                        <option value="Type 4">Type 4 (Olive/Tan)</option>
                        <option value="Type 5">Type 5 (Dark Brown)</option>
                        <option value="Type 6">Type 6 (Black)</option>
                    </select>
                </div>

                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CIELAB TOGGLE (NEW) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div class="control-group" style="margin-left: auto;">
                    <label>Skin Normalisation</label>
                    <div class="cielab-toggle-wrap">
                        <span class="cielab-icon">üî¨</span>
                        <div class="cielab-label-block">
                            <span class="cielab-title">CIELAB</span>
                            <span class="cielab-sub">Bias reduction</span>
                        </div>
                        <label class="cielab-switch">
                            <input type="checkbox" id="cielabToggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="cielab-status-txt" id="cielabStatus">Active</span>
                    </div>
                </div>
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            </div>

            <!-- Row 2: Mic / Breathing / Music / Actions -->
            <div class="controls">
                <div class="control-group">
                    <label>Microphone</label>
                    <select id="micSelect"></select>
                </div>
                <div class="control-group">
                    <label>Breathing Cycles</label>
                    <select id="breathCount">
                        <option value="10">10 Cycles</option>
                        <option value="15" selected>15 Cycles</option>
                        <option value="20">20 Cycles</option>
                        <option value="25">25 Cycles</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Background Music</label>
                    <select id="musicSelect">
                        <option value="none">No Music</option>
                        <option value="assets/ohhm.mp3" selected>Calm Meditation (Local)</option>
                        <option value="assets/deep_relaxation.mp3">Deep Relaxation
                        </option>
                        <option value="https://cdn.pixabay.com/audio/2022/08/23/audio_2e6d339bcc.mp3">Peaceful Zen
                        </option>
                        <option value="https://cdn.pixabay.com/audio/2023/02/28/audio_4dfed6d6c1.mp3">Nature Sounds
                        </option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Music Volume</label>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <input type="range" id="musicVolume" min="0" max="100" value="30"
                            style="width:120px;height:6px;background:var(--bg-tertiary);border-radius:var(--radius-full);cursor:pointer;">
                        <span id="volumeLabel"
                            style="font-size:0.75rem;color:var(--text-muted);min-width:35px;">30%</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="allowMicBtn" class="btn btn-secondary"><span>üé§</span> Mic</button>
                    <button id="allowCam" class="btn btn-secondary"><span>üì∑</span> Camera</button>
                    <button id="startBtn" class="btn btn-primary"><span>‚ñ∂Ô∏è</span> Start</button>
                    <button id="stopBtn" class="btn btn-secondary"><span>‚èπ</span> Stop</button>
                </div>
            </div>

            <!-- Status row -->
            <div class="status-badge" id="statusBadge">
                <span class="status-dot"></span>
                <span id="sessionStatus">Idle</span>
                <span id="musicLoading"
                    style="display:none; margin-left:10px; font-size:0.6rem; color:var(--accent); font-weight:700;">‚åõ
                    Loading Audio...</span>
                <audio id="bgAudio" loop preload="auto" crossorigin="anonymous"></audio>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            

            <!-- Audio Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span>üéµ</span> Audio Analysis</div>
                    <div class="card-subtitle">Breath pattern visualization</div>
                </div>

                <canvas id="waveCanvas"></canvas>

                <div class="audio-stats">
                    <div class="stat-box">
                        <div class="label">Breath Consistency</div>
                        <div class="value" id="breathConsTxt">‚Äî</div>
                        <div class="bar">
                            <div class="bar-fill" id="breathConsBar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="label">Microphone Level</div>
                        <div class="value" id="micLvl">‚Äî</div>
                        <div class="bar">
                            <div class="bar-fill" id="micLvlBar" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <div class="audio-actions">
                    <button id="muteBtn" class="btn btn-secondary btn-icon">üîà</button>
                    <button id="refreshMics" class="btn btn-secondary btn-icon">üîÑ</button>
                </div>
            </div>


            <!-- Face Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"><span>üëÅÔ∏è</span> Facial Analysis</div>
                    <div class="card-subtitle">Real-time meditation state detection</div>
                </div>

                <div id="faceWrap">
                    <video class="input_video" autoplay playsinline muted></video>
                    <canvas class="output_canvas"></canvas>
                </div>

                <div class="metrics-row">
                    <div class="metric-box">
                        <div class="label">Eye Relaxation</div>
                        <div class="value" id="eyeScoreTxt">0%</div>
                        <div class="bar">
                            <div class="bar-fill" id="eyeBar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Head Steady</div>
                        <div class="value" id="headScoreTxt">0%</div>
                        <div class="bar">
                            <div class="bar-fill" id="headBar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="metric-box">
                        <div class="label">Gaze Stable</div>
                        <div class="value" id="gazeScoreTxt">0%</div>
                        <div class="bar">
                            <div class="bar-fill" id="gazeBar" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <div class="info-footer">
                    <span>FPS: <span id="fps">‚Äî</span></span>
                    <span>Faces: <span id="facesDetected">0</span></span>
                </div>
            </div>
            <!-- Breathing Card with REALISTIC 3D HEART -->
            <div class="card breathing-card">
                <div class="card-header" style="width:100%;">
                    <div class="card-title"><span>üí®</span> Breathing Guide</div>
                    <div class="card-subtitle">Follow the rhythm</div>
                </div>

                <div class="heart-container">
                    <div id="breathingCircle" class="breathing-circle"></div>
                </div>

                <div id="breathStatus" class="breath-status">Ready to begin</div>

                <div class="progress-section">
                    <div class="label">Session Progress</div>
                    <div class="progress-bar-lg">
                        <div class="fill" id="sessionMeter" style="width:0%"></div>
                    </div>
                </div>

                <div class="rppg-panel">
                    <div class="rppg-header">
                        <div class="rppg-title">‚ù§Ô∏è Heart Rate Monitor</div>
                        <div class="bpm-value" id="bpmDisplay">‚Äî BPM</div>
                    </div>

                    <div class="rppg-stats">
                        <div class="rppg-stat">
                            <div class="label">Heart Rate</div>
                            <div class="value" id="heartrateTxt">0 bpm</div>
                            <div class="bar">
                                <div class="bar-fill" id="heartrateBar" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="rppg-stat">
                            <div class="label">SDNN</div>
                            <div class="value" id="sdnnTxt">0 ms</div>
                            <div class="bar">
                                <div class="bar-fill" id="sdnnBar" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="rppg-stat">
                            <div class="label">RMSSD</div>
                            <div class="value" id="rmssdTxt">0 ms</div>
                            <div class="bar">
                                <div class="bar-fill" id="rmssdBar" style="width:0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Signal Quality Indicator (New) -->
                <div
                    style="margin-top: 1rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: var(--radius-sm);">
                    <div
                        style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.3rem; color: var(--text-secondary);">
                        <span>Signal Quality</span>
                        <span id="signalQualityTxt">Waiting...</span>
                    </div>
                    <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                        <div id="signalQualityBar"
                            style="width: 0%; height: 100%; background: var(--warning); transition: width 0.3s ease, background 0.3s ease;">
                        </div>
                    </div>
                </div>

                <div class="rppg-tip">üí° Keep steady and maintain good lighting</div>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="results-card">
        <div class="card-title"><span>üìä</span> Session Results</div>

        <div class="results-grid">
            <div class="result-box">
                <div class="header">
                    <div class="label">Face Calmness</div>
                    <div class="value" id="faceCalmTxt">‚Äî</div>
                </div>
                <div class="bar">
                    <div class="bar-fill" id="faceCalmBar" style="width:0%"></div>
                </div>
            </div>
            <div class="result-box">
                <div class="header">
                    <div class="label">Breath Consistency</div>
                    <div class="value" id="breathConsTxt2">‚Äî</div>
                </div>
                <div class="bar">
                    <div class="bar-fill" id="breathConsBar2" style="width:0%"></div>
                </div>
            </div>
            <div class="result-box">
                <div class="header">
                    <div class="label">Meditation Index</div>
                    <div class="value" id="meditationIndexTxt">‚Äî</div>
                </div>
                <div class="bar">
                    <div class="bar-fill" id="meditationIndexBar" style="width:0%"></div>
                </div>
            </div>
            <div class="result-box">
                <div class="header">
                    <div class="label">Overall Score</div>
                    <div class="value" id="overallTxt">‚Äî</div>
                </div>
                <div class="bar">
                    <div class="bar-fill" id="overallBar" style="width:0%"></div>
                </div>
            </div>
        </div>

        <div class="overall-note" id="overallNote"></div>
    </div>

    <!-- History -->
    <div class="history-card">
        <div class="card-title"><span>üìà</span> Session History</div>
        <table class="history-table">
           <thead>
  <tr>
    <th>Date & Time</th>
    <th>User Name</th>
    <th>Profile (Age/Tone)</th>
    <th>Duration</th>        
    <th>BPM</th>             
    <th>Face</th>
    <th>Breath</th>
    <th>Meditation</th>
    <th>Overall</th>
  </tr>
</thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
    <!-- Authenticity & Privacy Footer -->
    <div
        style="margin-top: 3rem; text-align: center; color: var(--text-secondary); font-size: 0.8rem; padding-bottom: 2rem;">
        <div
            style="display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(16, 185, 129, 0.1); padding: 0.5rem 1rem; border-radius: 999px; margin-bottom: 1rem; border: 1px solid rgba(16, 185, 129, 0.2);">
            <span>üîí</span>
            <strong>Privacy First:</strong> All analysis happens locally on your device. No video data is sent to
            the cloud.
        </div>
        <p style="max-width: 600px; margin: 0 auto; line-height: 1.6;">
            <strong>Disclaimer:</strong> This application is a wellness tool designed for relaxation and meditation.
            It is <em>not</em> a medical device and should not be used for diagnosis or treatment.
            Heart rate and HRV metrics are estimates based on optical processing throughout the session.
        </p>
    </div>
    </div>

    <script src="app.js"></script>
    <script>
        const statusBadge = document.getElementById('statusBadge');
        const sessionStatus = document.getElementById('sessionStatus');
        const originalTextContent = Object.getOwnPropertyDescriptor(Node.prototype, 'textContent');
        Object.defineProperty(sessionStatus, 'textContent', {
            set: function (v) {
                originalTextContent.set.call(this, v);
                statusBadge.classList.toggle('active', v === 'running');
            },
            get: function () { return originalTextContent.get.call(this); }
        });
    </script>
</body>

</html>